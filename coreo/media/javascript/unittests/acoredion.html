<html>
<head>
	<title>Acoredion Demo</title>
	
	<link rel="stylesheet" type="text/css" href="../../css/ui-lightness/jquery-ui-1.8.6.custom.css" />
	<link rel="stylesheet" type="text/css" href="../../css/jquery.resultslist.css" />

	<style type="text/css">
		#acoredion {
			float: left;
			clear: none;
			width: 370px;
			height: 700px;
		}
		#results {
			float: left;
			width: 300px;
			height: 100%;;
		}
	</style>
	
	<script type="text/javascript" src="../jQuery/jquery-1.5.min.js"></script>
	<script type="text/javascript" src="../jQuery/jquery-ui-1.8.6.custom.min.js"></script>
	<script src="http://www.google.com/jsapi?key=ABQIAAAAtuDq1IioWnrYLMDZJXDaeBQtbCeXV1AaC_9GYwinjG7jMEsspxSTIxD1kpEv2TI4AyMEOkPYRiTVPQ"></script>
	<script type="text/javascript" src="../jstree/jquery.jstree.js"></script>
	<script type="text/javascript" src="../jstree/jquery.jstree.lazyload.js"></script>
	<script type="text/javascript" src="../jstree/jquery.jstree.bettercheckbox.js"></script>
	<script type="text/javascript" src="../core.geo/kmlfeaturetype.js"></script>
	<script type="text/javascript" src="../core.util/uri.js"></script>
	<script type="text/javascript" src="../core.util/idsequence.js"></script>
	<script type="text/javascript" src="../core.util/assert.js"></script>
	<script type="text/javascript" src="../core.util/callbackutils.js"></script>
	<script type="text/javascript" src="../core.util/objectutils.js"></script>
	<script type="text/javascript" src="../core.util/qualifiedname.js"></script>
	<script type="text/javascript" src="../core.util/namespacecontext.js"></script>
	<script type="text/javascript" src="../core.util/xmlutils.js"></script>
	<script type="text/javascript" src="../core.util/kmlutils.js"></script>
	<script type="text/javascript" src="../core.geo/geodatastore.js"></script>
	<script type="text/javascript" src="../core.geo/geodata.js"></script>
	<script type="text/javascript" src="../core.geo/networklinkgeodata.js"></script>
	<script type="text/javascript" src="../core.geo/kmlnodegeodata.js"></script>
	<script type="text/javascript" src="../core.geo/kmljsongeodata.js"></script>
	
	<script type="text/javascript" src="../core.events/event.js"></script>
	<script type="text/javascript" src="../core.events/geodataevent.js"></script>
	<script type="text/javascript" src="../core.events/showfeatureevent.js"></script>
	<script type="text/javascript" src="../core.events/hidefeatureevent.js"></script>
	<script type="text/javascript" src="../core.events/geodataloadedevent.js"></script>
	<script type="text/javascript" src="../core.events/geodataupdatebeginevent.js"></script>
	<script type="text/javascript" src="../core.events/geodataupdateendevent.js"></script>
	<script type="text/javascript" src="../core.events/viewchangedevent.js"></script>
	<script type="text/javascript" src="../core.events/featureinfoevent.js"></script>
	<script type="text/javascript" src="../core.events/eventchannel.js"></script>
	
	<script type="text/javascript" src="../core.ui/geodatatree.js"></script>
	<script type="text/javascript" src="../core.ui/acoredion.js"></script>
	<script type="text/javascript" src="../core.services/searchservice.js"></script>
	<script type="text/javascript" src="../core.services/kmlretriever.js"></script>
	<script type="text/javascript" src="../core.services/proxykmlretriever.js"></script>
	<script type="text/javascript" src="../core.services/geodataretriever.js"></script>
	<script type="text/javascript" src="../core.services/kmlgeodataretriever.js"></script>
	<script type="text/javascript" src="../core.services/kmljsonproxyservice.js"></script>
	<script type="text/javascript" src="../core.services/kmljsongeodataretriever.js"></script>
	<script type="text/javascript" src="../core.services/searchstrategy.js"></script>
	<script type="text/javascript" src="../core.geo/networklinkqueue.js"></script>
	
	<script type="text/javascript" src="../core.ui/jquery.resultslist.js"></script>

	<script type="text/javascript">
		google.load("maps", "2");

		$(document).ready(function() {
			/*
			var geoxml = new google.maps.GeoXml("http://localhost:8080/site_media/kml/top_eleven.kml");
			google.maps.Event.addListener(geoxml, "load", function() {
				console.log(core.util.ObjectUtils.describeFunctions(geoxml));
			});
			*/

			var kmlJsonProxyService = new core.services.KmlJsonProxyService("/kmlproxy")
			var geodataRetriever = new core.services.KmlJsonGeoDataRetriever(kmlJsonProxyService);
			var eventChannel = new core.events.EventChannel();
			var currentBbox = null;
			var currentAltitude = null;
			var networkLinkQueue = new core.geo.NetworkLinkQueue(geodataRetriever, 
					eventChannel, currentBbox, currentAltitude);

			var searchService = new core.services.SearchService("/search/links", "/search/libraries");
			/*
			var MAX_RESULTS = 3;
			var resultFilter = {
				cb: null,
				resultCount: 0,
				begin: $.proxy(function(callback) {
					this.cb = callback;
					this.resultCount = 0;
				}, this),
				result: $.proxy(function(data) {
					this.resultCount++;
					if (this.resultCount <= MAX_RESULTS) {
						core.util.CallbackUtils.invokeOptionalCallback(this.cb, "result", data);
					}
					else {
						console.log("Skipping - too many results");
					}
				}, this),
				end: $.proxy(function() {}, this),
				error: $.proxy(function(err) {
					console.log("ERROR: " + err);
				}, this)
			};
			*/
			var resultFilter = {
				callback: null,
				resultCount: 0,
				begin: function(callback) {
					this.callback = callback;
					this.resultCount = 0;
					$("#results").resultslist({
						title: "Search Results"
					});
					$("#results").resultslist("setMessage", "Searching...");
					$("#results").bind("clickresult", $.proxy(function(evt, resultId, linkOrLibrary) {
						core.util.CallbackUtils.invokeCallback(this.callback, linkOrLibrary, "result");
						$("#results").resultslist("removeResult", resultId);
					}, this));
				},
				result: function(linkOrLibrary) {
					this.resultCount++;
					var title = linkOrLibrary.fields.name;
					var description = linkOrLibrary.fields.desc;
					var id = linkOrLibrary.pk;
					$("#results").resultslist("addResult", id, title, description, linkOrLibrary);
				},
				end: function() {
					$("#results").resultslist("setMessage", this.resultCount + " results found.");
				},
				error: function(err) {
					console.log("Search error: " + err);
				}
			};
			var searchStrategy = new core.services.SearchStrategy(searchService, resultFilter, geodataRetriever);
			var acoredion = new core.ui.Acoredion("#acoredion", searchStrategy, eventChannel, networkLinkQueue);
			
			/*
			var kml = "<k:kml xmlns:k=\"" + core.util.KmlUtils.KML_NS[0] + "\">"
				+ "<k:Document id=\"3\">"
				+ "  <k:name>Test Document</k:name>"
				+ "  <k:Folder>"
				+ "    <k:name>All Feature Types</k:name>"
				+ "    <k:Placemark></k:Placemark>"
				+ "    <k:PhotoOverlay></k:PhotoOverlay>"
				+ "    <k:GroundOverlay></k:GroundOverlay>"
				+ "    <k:ScreenOverlay></k:ScreenOverlay>"
				+ "    <k:Document></k:Document>"
				+ "    <k:NetworkLink />"
				+ "  </k:Folder>"
				+ "  <k:Placemark />"
				+ "</k:Document>"
				+ "</k:kml>";
			var geodata = core.geo.KmlNodeGeoData.fromKmlString(kml);

			var searchService = new core.services.SearchService("/search-links", "/search-libraries");
			var MAX_RESULTS = 3;
			var resultFilter = {
				cb: null,
				resultCount: 0,
				begin: $.proxy(function(callback) {
					this.cb = callback;
					this.resultCount = 0;
				}, this),
				result: $.proxy(function(data) {
					this.resultCount++;
					if (this.resultCount <= MAX_RESULTS) {
						core.util.CallbackUtils.invokeOptionalCallback(this.cb, "result", data);
					}
					else {
						console.log("Skipping - too many results");
					}
				}, this),
				end: $.proxy(function() {}, this),
				error: $.proxy(function(err) {
					console.log("ERROR: " + err);
				}, this)
			};
			var kmlRetriever = new core.services.GGeoXmlKmlRetriever();
			var searchStrategy = new core.services.SearchStrategy(searchService, resultFilter, kmlRetriever);
			var acoredion = new core.ui.Acoredion("#acoredion", searchStrategy);
			*/
			
			/*
			$("#results").resultslist({
				title: "Search Results"
			});
			$("#results").bind("clickresult", function(evt, resultId) {
				console.log("Clicked result " + resultId);
				$("#results").resultslist("removeResult", resultId);
			});
			for (var i = 0; i < 5; i++) {
				$("#results").resultslist("addResult", i, "Result " + i, "This is yet another result. Actually, this is result number " + i + ".");
			}
			$("#results").resultslist("setMessage", "5 results found for \"test\"");
			*/
			
			
		});
	</script>
</head>
<body>
	<div id="acoredion"></div>
	<div id="results"></div>
</body>
</html>